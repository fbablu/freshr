<!-- Zone Selected State -->
<div *ngIf="zoneId()" class="h-full flex flex-col">
  <!-- Header -->
  <div class="p-4 border-b border-slate-200 bg-slate-50">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-lg font-semibold text-slate-900">{{ zoneName() }}</h3>
        <div class="flex items-center gap-2 mt-1">
          <span
            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
            [ngClass]="{
              'bg-green-100 text-green-800': zoneState() === 'normal',
              'bg-yellow-100 text-yellow-800': zoneState() === 'at-risk',
              'bg-red-100 text-red-800': zoneState() === 'unsafe',
              'bg-blue-100 text-blue-800': zoneState() === 'recovering',
            }"
          >
            {{ zoneState() | titlecase }}
          </span>
          <span *ngIf="activeIncidentCount() > 0" class="text-xs text-slate-500">
            {{ activeIncidentCount() }} active incident{{ activeIncidentCount() > 1 ? 's' : '' }}
          </span>
        </div>
      </div>
      <button (click)="close.emit()" class="p-1 hover:bg-slate-200 rounded transition-colors">
        <mat-icon class="!text-[20px] !w-5 !h-5 text-slate-500">close</mat-icon>
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="border-b border-slate-200 bg-white">
    <div class="flex">
      <button
        *ngFor="let tab of tabs"
        (click)="activeTab.set(tab.id)"
        class="flex-1 px-3 py-2 text-xs font-medium transition-colors border-b-2"
        [ngClass]="{
          'border-blue-600 text-blue-600': activeTab() === tab.id,
          'border-transparent text-slate-600 hover:text-slate-900': activeTab() !== tab.id,
        }"
      >
        <div class="flex items-center justify-center gap-1">
          <mat-icon class="!text-[16px] !w-4 !h-4">{{ tab.icon }}</mat-icon>
          <span>{{ tab.label }}</span>
        </div>
      </button>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="flex-1 overflow-y-auto p-4">
    <!-- Summary Tab -->
    <div *ngIf="activeTab() === 'summary'" class="space-y-4">
      <!-- Active Incidents -->
      <div *ngIf="zoneIncidents().length > 0">
        <h4 class="text-sm font-semibold text-slate-700 mb-2">Active Incidents</h4>
        <div class="space-y-2">
          <div
            *ngFor="let incident of zoneIncidents()"
            class="p-3 rounded-lg border"
            [ngClass]="{
              'bg-red-50 border-red-200': incident.anomaly.severity === 'critical',
              'bg-orange-50 border-orange-200': incident.anomaly.severity === 'high',
              'bg-yellow-50 border-yellow-200': incident.anomaly.severity === 'medium',
              'bg-slate-50 border-slate-200': incident.anomaly.severity === 'low',
            }"
          >
            <div class="flex items-start justify-between">
              <div>
                <div class="text-sm font-medium text-slate-900">
                  {{ formatSensorType(incident.anomaly.sensor_type) }}
                </div>
                <div class="text-xs text-slate-600 mt-1">
                  {{ incident.requiredAction }}
                </div>
              </div>
              <span
                class="text-xs font-medium px-2 py-0.5 rounded"
                [ngClass]="{
                  'bg-red-200 text-red-800': incident.anomaly.severity === 'critical',
                  'bg-orange-200 text-orange-800': incident.anomaly.severity === 'high',
                  'bg-yellow-200 text-yellow-800': incident.anomaly.severity === 'medium',
                }"
              >
                {{ incident.anomaly.severity | uppercase }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Latest Reading -->
      <div *ngIf="recentMeasurement()">
        <h4 class="text-sm font-semibold text-slate-700 mb-2">Latest Reading</h4>
        <div class="p-3 bg-slate-50 rounded-lg">
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-600">
              {{ formatMeasurementType(recentMeasurement()!.measurement_type) }}
            </span>
            <span class="text-lg font-semibold text-slate-900">
              {{ formatMeasurementValue(recentMeasurement()!) }}
            </span>
          </div>
          <div class="text-xs text-slate-500 mt-1">
            {{ formatTimestamp(recentMeasurement()!.timestamp) }}
          </div>
        </div>
      </div>

      <!-- No incidents state -->
      <div *ngIf="zoneIncidents().length === 0" class="text-center py-8 text-slate-500">
        <mat-icon class="!text-[32px] !w-8 !h-8 mx-auto mb-2 text-green-500">check_circle</mat-icon>
        <p class="text-sm">No active incidents in this zone</p>
      </div>
    </div>

    <!-- Signals Tab -->
    <div *ngIf="activeTab() === 'signals'" class="space-y-3">
      <div class="text-sm text-slate-600 mb-3">Recent sensor readings</div>

      <div
        *ngFor="let measurement of zoneMeasurements()"
        class="p-3 bg-slate-50 rounded-lg flex items-center justify-between"
      >
        <div>
          <div class="text-sm font-medium text-slate-900">
            {{ formatMeasurementType(measurement.measurement_type) }}
          </div>
          <div class="text-xs text-slate-600 mt-1">Sensor: {{ measurement.sensor_id }}</div>
          <div class="text-xs text-slate-500 mt-1">
            {{ formatTimestamp(measurement.timestamp) }}
          </div>
        </div>
        <div class="text-right">
          <div class="text-lg font-semibold text-slate-900">
            {{ formatMeasurementValue(measurement) }}
          </div>
        </div>
      </div>

      <div *ngIf="zoneMeasurements().length === 0" class="text-center py-8 text-slate-500">
        No historical data available
      </div>
    </div>

    <!-- Replay Tab -->
    <div *ngIf="activeTab() === 'replay'" class="space-y-4">
      <div class="text-sm text-slate-600 mb-3">Timeline of events in this zone</div>

      <!-- Timeline -->
      <div class="relative">
        <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-slate-200"></div>

        <div *ngFor="let event of replayEvents()" class="relative pl-10 pb-4">
          <div
            class="absolute left-2.5 w-3 h-3 rounded-full border-2 border-white"
            [ngClass]="{
              'bg-red-500': event.type === 'anomaly',
              'bg-blue-500': event.type === 'measurement',
              'bg-green-500': event.type === 'action',
            }"
          ></div>
          <div class="bg-slate-50 rounded-lg p-3">
            <div class="flex items-center justify-between">
              <span class="text-xs font-medium text-slate-500">
                {{ formatTimestamp(event.timestamp) }}
              </span>
              <span
                *ngIf="event.severity"
                class="text-xs px-1.5 py-0.5 rounded"
                [ngClass]="{
                  'bg-red-100 text-red-700': event.severity === 'critical',
                  'bg-orange-100 text-orange-700': event.severity === 'high',
                  'bg-yellow-100 text-yellow-700': event.severity === 'medium',
                }"
              >
                {{ event.severity }}
              </span>
            </div>
            <div class="text-sm text-slate-900 mt-1">{{ event.label }}</div>
            <div *ngIf="event.value" class="text-xs text-slate-600 mt-1">
              {{ event.value }}
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="replayEvents().length === 0" class="text-center py-8 text-slate-500">
        <mat-icon class="!text-[32px] !w-8 !h-8 mx-auto mb-2 text-slate-400">timeline</mat-icon>
        <p class="text-sm">No events to replay</p>
      </div>
    </div>

    <!-- AI Explanation Tab -->
    <div *ngIf="activeTab() === 'ai'" class="space-y-4">
      <!-- Loading state -->
      <div *ngIf="aiLoading()" class="text-center py-8">
        <mat-icon class="!text-[32px] !w-8 !h-8 mx-auto mb-2 text-blue-500 animate-pulse"
          >auto_awesome</mat-icon
        >
        <p class="text-sm text-slate-600">Generating AI explanation...</p>
      </div>

      <!-- Error state -->
      <div *ngIf="aiError()" class="text-center py-8 text-red-500">
        <mat-icon class="!text-[32px] !w-8 !h-8 mx-auto mb-2">error</mat-icon>
        <p class="text-sm">{{ aiError() }}</p>
        <button (click)="loadAIExplanation()" class="mt-2 text-xs text-blue-600 hover:underline">
          Try again
        </button>
      </div>

      <!-- AI Content -->
      <div *ngIf="aiExplanation() && !aiLoading()">
        <!-- What Happened -->
        <div class="mb-4">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
              <mat-icon class="!text-[16px] !w-4 !h-4 text-red-700">warning</mat-icon>
            </div>
            <h4 class="text-sm font-semibold text-slate-900">What Happened</h4>
          </div>
          <p class="text-sm text-slate-700 leading-relaxed">
            {{ aiExplanation()!.what_happened }}
          </p>
        </div>

        <!-- Why It Matters -->
        <div class="mb-4">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
              <mat-icon class="!text-[16px] !w-4 !h-4 text-orange-700">priority_high</mat-icon>
            </div>
            <h4 class="text-sm font-semibold text-slate-900">Why It Matters</h4>
          </div>
          <p class="text-sm text-slate-700 leading-relaxed">
            {{ aiExplanation()!.why_it_matters }}
          </p>
        </div>

        <!-- What To Do -->
        <div class="mb-4">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
              <mat-icon class="!text-[16px] !w-4 !h-4 text-blue-700">checklist</mat-icon>
            </div>
            <h4 class="text-sm font-semibold text-slate-900">What To Do</h4>
          </div>
          <ul class="space-y-1">
            <li
              *ngFor="let action of aiExplanation()!.what_to_do"
              class="flex items-start gap-2 text-sm text-slate-700"
            >
              <mat-icon class="!text-[14px] !w-3.5 !h-3.5 text-blue-600 mt-0.5 flex-shrink-0"
                >arrow_right</mat-icon
              >
              <span>{{ action }}</span>
            </li>
          </ul>
        </div>

        <!-- Confirm Recovery -->
        <div>
          <div class="flex items-center gap-2 mb-2">
            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
              <mat-icon class="!text-[16px] !w-4 !h-4 text-green-700">verified</mat-icon>
            </div>
            <h4 class="text-sm font-semibold text-slate-900">Confirm Recovery</h4>
          </div>
          <p class="text-sm text-slate-700 leading-relaxed">
            {{ aiExplanation()!.confirm_recovery }}
          </p>
        </div>

        <!-- Source badge -->
        <div class="mt-4 pt-4 border-t border-slate-200">
          <span class="inline-flex items-center gap-1 text-xs text-slate-500">
            <mat-icon class="!text-[12px] !w-3 !h-3">auto_awesome</mat-icon>
            Powered by {{ aiSource() === 'gemini' ? 'Gemini AI' : 'Freshr Intelligence' }}
          </span>
        </div>
      </div>

      <!-- No incidents for AI -->
      <div
        *ngIf="!aiExplanation() && !aiLoading() && !aiError() && zoneIncidents().length === 0"
        class="text-center py-8 text-slate-500"
      >
        <mat-icon class="!text-[32px] !w-8 !h-8 mx-auto mb-2 text-slate-400">auto_awesome</mat-icon>
        <p class="text-sm">No incidents to analyze</p>
        <p class="text-xs mt-1">AI explanations appear when anomalies are detected</p>
      </div>
    </div>
  </div>
</div>

<!-- Empty State -->
<div *ngIf="!zoneId()" class="h-full flex items-center justify-center text-slate-500">
  <div class="text-center">
    <mat-icon class="!text-[48px] !w-12 !h-12 mx-auto mb-3 text-slate-300">location_on</mat-icon>
    <p>Select a zone to view details</p>
  </div>
</div>
